###################################
# Copyright (c) CEP Research Institude, All rights reserved. Since 2008
# Kage Park
# License : GPL
####################################
_ofed_help() {
       echo "ofed <option>"
       echo " <option>"
       echo "  -fd  : Find device id"
       echo "  -d <device id>  : display <device id> information"
       echo "  -i <image file> : display <image file> information"
       echo "  -backup <backup image path> : It need '-d' option"
       echo "  -b : Burn image to rom, It need '-d' and '-i' option"
       echo "    -force : Force Burn Image to rom"
       exit
}
ofed() {
   _k_root
   if [ "$#" == "0" ]; then
       _ofed_help
   fi
   fw_file=$(_k_opt -i 1 0 "$@")
   fw_dev=$(_k_opt -d 1 0 "$@")
   _k_opt -force 0 0 "$@" >/dev/null && force_burn=1
   if backup_file=$(_k_opt -backup 1 0 "$@"); then
     if [ -f "$backup_file" ]; then
        echo "Already $backup_file exist"
        exit
     fi
     if [ -n "$fw_dev" ]; then
        mstflint -d ${fw_dev} ri $backup_file
     else
        _ofed_help
     fi
   elif _k_opt -fd 0 0 "$@" >/dev/null; then
     lspci -vv | grep -i mella
   elif _k_opt -b 0 0 "$@" >/dev/null; then
     if [ -n "$fw_file" -a -f "$fw_file" -a -n "$fw_dev" ]; then
        x=$(mstflint -i $fw_file q)
        firmware_board_id=$(echo "$x" | grep PSID | awk '{print $2;}')
        board_id=$(mstflint -d $fw_dev q | grep PSID | awk '{print $2;}')
        if [ "$firmware_board_id" == "$board_id" ]; then
            echo ""
            echo "Burning firmware image ($fw_file) to $fw_dev (do not interrupt) ..."
            echo ""
            if [ "$force_burn" == "1" ]; then
                echo n | mstflint -d $fw_dev -y -skip_is -i $fw_file burn
            else
                echo n | mstflint -d $fw_dev -i $fw_file burn
            fi
        else
            error_exit "Mismatched board_id"
        fi
     else
        _ofed_help
     fi
   elif [ -n "$fw_file" -a -f "$fw_file" ]; then
     mstflint -i $fw_file q
   elif [ -n "$fw_dev" ]; then
     mstflint -d $fw_dev q
   else
     _ofed_help
   fi
}
